<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>·ª®ng D·ª•ng Truy·ªÅn File Ch·ªØ K√Ω S·ªë</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Roboto', sans-serif; margin: 0; padding: 20px; background: linear-gradient(to bottom, #B0E1FA, #E8BDDB); color: #333; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1, h2 { color: #0056b3; }
        fieldset { border: 2px solid #0056b3; border-radius: 5px; padding: 15px; margin-bottom: 20px; }
        legend { font-weight: bold; color: #0056b3; }
        .form-group { margin-bottom: 15px; display: flex; align-items: center; }
        .form-group label { flex: 0 0 150px; margin-right: 10px; text-align: right; }
        .form-group input[type="text"], .form-group input[type="number"], .form-group input[type="file"] { flex: 1; padding: 10px; border: 2px solid #ccc; border-radius: 4px; transition: border 0.3s; }
        .form-group input[type="text"]:focus, .form-group input[type="number"]:focus { border-color: #0056b3; }
        .form-group button { padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin-left: 10px; transition: background 0.3s; }
        .form-group button:hover { background-color: #0056b3; }
        .log-output { background-color: #e9e9e9; border: 1px solid #ccc; padding: 10px; max-height: 200px; overflow-y: auto; border-radius: 4px; font-family: monospace; font-size: 0.9em; white-space: pre-wrap; word-wrap: break-word; }
        .status-message { padding: 10px; margin-bottom: 10px; border-radius: 4px; }
        .status-info { background-color: #e0f7fa; border: 1px solid #b2ebf2; color: #00796b; }
        .status-success { background-color: #e8f5e9; border: 1px solid #c8e6c9; color: #388e3c; }
        .status-warning { background-color: #fffde7; border: 1px solid #fff59d; color: #fbc02d; }
        .status-error { background-color: #ffebee; border: 1px solid #ffcdd2; color: #d32f2f; }
        .recipient-entry { display: flex; gap: 10px; margin-bottom: 10px; }
        .recipient-entry input { flex: 1; padding: 5px; border-radius: 4px; border: 1px solid #ccc; }
    </style>
</head>
<body>
    <div class="container">
        <h1>·ª®ng D·ª•ng Truy·ªÅn File Ch·ªØ K√Ω S·ªë</h1>

        <fieldset>
            <legend>Th√¥ng Tin Server</legend>
            <div class="form-group">
                <label for="serverIp">IP Server:</label>
                <input type="text" id="serverIp" value="0.0.0.0">
            </div>
            <div class="form-group">
                <label for="serverPort">C·ªïng:</label>
                <input type="number" id="serverPort" value="8889">
            </div>
            <div class="form-group">
                <button id="startServerBtn">K·∫øt N·ªëi (B·∫Øt ƒê·∫ßu Server)</button>
                <button id="stopServerBtn" disabled>Ng·∫Øt K·∫øt N·ªëi (D·ª´ng Server)</button>
            </div>
            <div id="serverStatus" class="status-message status-info">Tr·∫°ng Th√°i Server: Ch∆∞a ch·∫°y</div>
        </fieldset>

        <fieldset>
            <legend>Th√¥ng Tin Ng∆∞·ªùi Nh·∫≠n (Client)</legend>
            <div id="recipientsContainer">
                <div class="recipient-entry">
                    <input type="text" placeholder="IP Ng∆∞·ªùi Nh·∫≠n" class="recipient-ip" value="127.0.0.1">
                    <input type="number" placeholder="Port" class="recipient-port" value="8889">
                    <button onclick="removeRecipient(this)">Xo√°</button>
                </div>
            </div>
            <div class="form-group">
                <label></label>
                <button onclick="addRecipient()">+ Th√™m Ng∆∞·ªùi Nh·∫≠n</button>
            </div>
            <div class="form-group">
                <label for="fileInput">Ch·ªçn File:</label>
                <input type="file" id="fileInput">
            </div>
            <div class="form-group">
                <button id="sendFileBtn">G·ª≠i File</button>
            </div>
            <div id="clientStatus" class="status-message status-info">Tr·∫°ng Th√°i Client: S·∫µn S√†ng</div>
        </fieldset>

        <fieldset>
            <legend>C√†i ƒê·∫∑t ·ª®ng D·ª•ng</legend>
            <div class="form-group">
                <label for="segmentSize">K√≠ch Th∆∞·ªõc Ph√¢n ƒêo·∫°n (Bytes):</label>
                <input type="number" id="segmentSize" value="65536">
            </div>
            <div class="form-group">
                <button id="applySettingsBtn">√Åp D·ª•ng C√†i ƒê·∫∑t</button>
            </div>
        </fieldset>

        <fieldset>
            <legend>Log Output</legend>
            <div id="logOutput" class="log-output"></div>
        </fieldset>
    </div>

    <script>
        const socket = io();

        const startServerBtn = document.getElementById('startServerBtn');
        const stopServerBtn = document.getElementById('stopServerBtn');
        const serverStatusDiv = document.getElementById('serverStatus');

        const fileInput = document.getElementById('fileInput');
        const sendFileBtn = document.getElementById('sendFileBtn');
        const clientStatusDiv = document.getElementById('clientStatus');
        const segmentSizeInput = document.getElementById('segmentSize');
        const applySettingsBtn = document.getElementById('applySettingsBtn');
        const logOutputDiv = document.getElementById('logOutput');

        socket.on('connect', () => {
            logMessage('K·∫øt n·ªëi ƒë·∫øn server Flask-SocketIO th√†nh c√¥ng.');
        });

        socket.on('log_message', msg => {
            logMessage(msg);
        });

        socket.on('server_status', data => {
            updateStatus(serverStatusDiv, data.message, data.type);
            startServerBtn.disabled = data.type === 'info' && data.message.includes('Server started');
            stopServerBtn.disabled = !startServerBtn.disabled;
        });

        socket.on('client_status', data => {
            updateStatus(clientStatusDiv, data.message, data.type);
        });

        startServerBtn.addEventListener('click', () => {
            const ip = document.getElementById('serverIp').value;
            const port = parseInt(document.getElementById('serverPort').value);
            if (!ip || isNaN(port)) {
                alert("Vui l√≤ng nh·∫≠p IP v√† Port h·ª£p l·ªá cho server.");
                return;
            }
            socket.emit('start_server', { ip, port });
        });

        stopServerBtn.addEventListener('click', () => {
            socket.emit('stop_server');
        });

        sendFileBtn.addEventListener('click', () => {
            const segmentSize = parseInt(segmentSizeInput.value);
            const file = fileInput.files[0];
            if (!file) {
                alert("Vui l√≤ng ch·ªçn m·ªôt file.");
                return;
            }

            if (isNaN(segmentSize) || segmentSize <= 0) {
                alert("K√≠ch th∆∞·ªõc ph√¢n ƒëo·∫°n kh√¥ng h·ª£p l·ªá.");
                return;
            }

            const recipients = document.querySelectorAll('.recipient-entry');
            if (recipients.length === 0) {
                alert("Vui l√≤ng th√™m √≠t nh·∫•t m·ªôt ng∆∞·ªùi nh·∫≠n.");
                return;
            }

            const reader = new FileReader();
            reader.onload = event => {
                const fileData = new Uint8Array(event.target.result);
                recipients.forEach(entry => {
                    const ip = entry.querySelector('.recipient-ip').value;
                    const port = parseInt(entry.querySelector('.recipient-port').value);
                    if (!ip || isNaN(port)) {
                        logMessage(`‚ö†Ô∏è B·ªè qua ng∆∞·ªùi nh·∫≠n v·ªõi IP/Port kh√¥ng h·ª£p l·ªá.`);
                        return;
                    }

                    socket.emit('send_file', {
                        ip, port,
                        file_name: file.name,
                        file_data: fileData,
                        segment_size: segmentSize
                    });

                    logMessage(`üì§ ƒêang g·ª≠i file t·ªõi ${ip}:${port}`);
                });
            };
            reader.readAsArrayBuffer(file);
        });

        applySettingsBtn.addEventListener('click', () => {
            try {
                const segmentSize = parseInt(segmentSizeInput.value);
                if (isNaN(segmentSize) || segmentSize <= 0) {
                    alert("K√≠ch th∆∞·ªõc ph√¢n ƒëo·∫°n ph·∫£i l√† s·ªë d∆∞∆°ng.");
                    return;
                }
                logMessage(`‚úÖ C√†i ƒë·∫∑t √°p d·ª•ng: Ph√¢n ƒëo·∫°n = ${segmentSize} bytes`);
                alert("ƒê√£ √°p d·ª•ng c√†i ƒë·∫∑t.");
            } catch (e) {
                alert(`L·ªói khi √°p d·ª•ng c√†i ƒë·∫∑t: ${e.message}`);
                logMessage(`‚ùå Error: ${e.message}`);
            }
        });

        function logMessage(message) {
            const now = new Date();
            const timestamp = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
            logOutputDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logOutputDiv.scrollTop = logOutputDiv.scrollHeight;
        }

        function updateStatus(div, message, type) {
            div.textContent = message;
            div.className = `status-message status-${type}`;
        }

        // Th√™m / Xo√° ng∆∞·ªùi nh·∫≠n
        function addRecipient() {
            const container = document.getElementById('recipientsContainer');
            const div = document.createElement('div');
            div.className = 'recipient-entry';
            div.innerHTML = `
                <input type="text" placeholder="IP Ng∆∞·ªùi Nh·∫≠n" class="recipient-ip" value="127.0.0.1">
                <input type="number" placeholder="Port" class="recipient-port" value="8889">
                <button onclick="removeRecipient(this)">Xo√°</button>
            `;
            container.appendChild(div);
        }

        function removeRecipient(btn) {
            const entry = btn.closest('.recipient-entry');
            entry.remove();
        }

        window.onload = function() {
            startServerBtn.disabled = false;
            stopServerBtn.disabled = true;
            sendFileBtn.disabled = false;
        };
    </script> 
</body>
</html>
